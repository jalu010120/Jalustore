// Utils - Debounce Function untuk search delay
const debounce = (fn, delay) => {
  let timer;
  return (...args) => {
    clearTimeout(timer);
    timer = setTimeout(() => fn.apply(this, args), delay);
  };
};

// State management sederhana
const state = {
  deliveryData: [],
  completedItemsShown: 12,
  itemsPerLoad: 12,
  statusFilter: 'all',
  searchTerm: ''
};

// DOM Elements Cache
const elements = {
  liveTimeEl: document.getElementById('live-time'),
  refreshButton: document.getElementById('refresh-button'),
  searchBox: document.getElementById('search-box'),
  statsContainer: document.getElementById('stats-container'),
  slotCards: {
    1: document.getElementById('slot1-cards'),
    2: document.getElementById('slot2-cards'),
    3: document.getElementById('slot3-cards'),
    4: document.getElementById('slot4-cards'),
  },
  completedCards: document.getElementById('completed-cards'),
  loadMoreBtn: document.getElementById('load-more-btn'),
  orderModal: document.getElementById('order-modal'),
  closeModalButton: document.getElementById('close-modal'),
  modalDetails: document.getElementById('modal-details'),
  whatsappButton: document.getElementById('whatsapp-button'),
  statusFilterEl: document.getElementById('status-filter'),
  failBadge: document.getElementById('fail-badge'),
};

// Show loading/spinner indicator during fetch
const showLoading = () => {
  elements.refreshButton.disabled = true;
  elements.refreshButton.querySelector('i').classList.add('fa-spin');
};

const hideLoading = () => {
  elements.refreshButton.disabled = false;
  elements.refreshButton.querySelector('i').classList.remove('fa-spin');
};

const fetchDeliveryData = async () => {
  showLoading();
  try {
    const response = await fetch('js/data.js');
    if (!response.ok) throw new Error('Gagal memuat data pengiriman.');
    const scriptText = await response.text();
    const dataFunction = new Function(scriptText + '; return deliveryData;');
    state.deliveryData = dataFunction();
    hideLoading();
    renderUI();
  } catch (error) {
    hideLoading();
    alert(error.message);
  }
};

const renderUI = () => {
  renderCards(state.searchTerm);
  updateStats();
};

const updateLiveTime = () => {
  const now = new Date();
  const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', 
                    hour: '2-digit', minute: '2-digit', second: '2-digit' };
  elements.liveTimeEl.textContent = now.toLocaleDateString('id-ID', options);
};

const renderCards = (searchTerm = '') => {
  Object.values(elements.slotCards).forEach(container => container.innerHTML = '');
  elements.completedCards.innerHTML = '';

  const term = searchTerm.toLowerCase();
  let filteredData = state.deliveryData.filter(item => {
    return (item.name && item.name.toLowerCase().includes(term)) ||
           (item.order && String(item.order).includes(term)) ||
           (item.send && String(item.send).includes(term));
  });

  if (state.statusFilter !== 'all') {
    filteredData = filteredData.filter(item => {
      if (state.statusFilter === 'done') return item.slot === 'completed' || item.send >= item.order;
      if (state.statusFilter === 'fail') return item.statusOverride === 'fail';
      if (state.statusFilter === 'pending') return item.slot !== 'completed' && item.send < item.order && item.statusOverride !== 'fail';
      return true;
    });
  }

  const pendingData = filteredData.filter(item => item.slot !== 'completed' && item.send < item.order && item.statusOverride !== 'fail');
  const completedData = filteredData.filter(item => item.slot === 'completed' || item.send >= item.order || item.statusOverride === 'fail');

  pendingData.forEach(item => {
    const card = createCardElement(item);
    (elements.slotCards[item.slot] || elements.slotCards[1]).appendChild(card);
  });

  const completedToShow = completedData.slice(0, state.completedItemsShown);
  completedToShow.forEach(item => {
    elements.completedCards.appendChild(createCardElement(item));
  });

  elements.loadMoreBtn.style.display = (completedData.length > state.completedItemsShown) ? 'block' : 'none';
};

const createCardElement = (item) => {
  const card = document.createElement('div');

  let statusClass = 'pending';
  let statusText = 'Proses';
  let statusIcon = 'fa-hourglass-half';
  let progress = item.order ? (item.send / item.order) * 100 : 0;

  if (item.statusOverride === 'fail') {
    statusClass = 'fail';
    statusText = 'Gagal';
    statusIcon = 'fa-times-circle';
  } else if (item.slot === 'completed' || (item.order && item.send >= item.order)) {
    statusClass = 'done';
    statusText = 'Selesai';
    statusIcon = 'fa-check-circle';
  }

  const progressHtml = (['pending', 'fail'].includes(statusClass) && item.order) ? 
    `<div class="progress-bar"><div class="progress-fill" style="width: ${progress.toFixed(0)}%;"></div></div>` : '';

  card.classList.add('card', statusClass);
  card.setAttribute('tabindex', '0');
  card.setAttribute('role', 'button');
  card.setAttribute('aria-pressed', 'false');

  card.innerHTML = `
    <div class="name">${item.name || '-'}</div>
    <div class="number">Order: ${item.order || '-'} | Terkirim: ${item.send || '-'}</div>
    ${progressHtml}
    <div class="status ${statusClass}">
      <i class="fas ${statusIcon}" aria-hidden="true"></i>
      ${statusText}
    </div>
  `;

  card.addEventListener('click', () => openOrderModal(item));
  card.addEventListener('keypress', (evt) => {
    if (evt.key === 'Enter' || evt.key === ' ') {
      evt.preventDefault();
      openOrderModal(item);
    }
  });

  return card;
};

const updateStats = () => {
  const totalOrders = state.deliveryData.length;
  const totalCompleted = state.deliveryData.filter(item => item.slot === 'completed' || (item.send >= item.order && item.statusOverride !== 'fail')).length;
  const totalPending = state.deliveryData.filter(item => item.slot !== 'completed' && item.send < item.order && item.statusOverride !== 'fail').length;
  const totalFailed = state.deliveryData.filter(item => item.statusOverride === 'fail').length;

  elements.statsContainer.innerHTML = `
    <div class="stat-card" role="region" aria-label="Total Order"><div class="stat-value">${totalOrders}</div><div class="stat-label">Total Order</div></div>
    <div class="stat-card" role="region" aria-label="Selesai"><div class="stat-value">${totalCompleted}</div><div class="stat-label">Selesai</div></div>
    <div class="stat-card" role="region" aria-label="Proses"><div class="stat-value">${totalPending}</div><div class="stat-label">Proses</div></div>
    <div class="stat-card" role="region" aria-label="Gagal"><div class="stat-value">${totalFailed}</div><div class="stat-label">Gagal</div></div>
  `;

  if (totalFailed > 0) {
    elements.failBadge.textContent = totalFailed;
    elements.failBadge.style.display = 'inline-block';
  } else {
    elements.failBadge.style.display = 'none';
  }
};

const openOrderModal = (item) => {
  elements.modalDetails.innerHTML = `
    <div class="detail-item"><div class="detail-label">Nama</div><div class="detail-value">${item.name || '-'}</div></div>
    <div class="detail-item"><div class="detail-label">Order</div><div class="detail-value">${item.order || '-'} Heart</div></div>
    <div class="detail-item"><div class="detail-label">Terkirim</div><div class="detail-value">${item.send || '-'} Heart</div></div>
    <div class="detail-item"><div class="detail-label">Sisa</div><div class="detail-value">${item.order && item.send ? item.order - item.send : '-'} Heart</div></div>
    <div class="detail-item" style="grid-column: 1 / -1;"><div class="detail-label">Status</div><div class="detail-value">${item.statusOverride === 'fail' ? 'Gagal' : (item.send >= item.order ? 'Selesai' : 'Proses')}</div></div>
    <div class="detail-item" style="grid-column: 1 / -1;"><div class="detail-label">Progress</div><div class="detail-value">${item.order ? ((item.send / item.order) * 100).toFixed(2) : '0'}%</div></div>
    ${item.number ? `<div class="detail-item" style="grid-column: 1 / -1;"><div class="detail-label">Nomor Telepon</div><div class="detail-value">${item.number}</div></div>` : ''}
    ${item.notes ? `<div class="detail-item" style="grid-column: 1 / -1;"><div class="detail-label">Catatan</div><div class="detail-value">${item.notes}</div></div>` : ''}
  `;

  if (item.number) {
    const cleanNumber = item.number.replace(/D/g, '');
    const whatsappLink = `https://wa.me/${cleanNumber}?text=${encodeURIComponent(`Halo ${item.name}, kami ingin menginformasikan status orderan heart Anda dengan jumlah order ${item.order} dan telah terkirim ${item.send}. Sisa pengiriman adalah ${item.order - item.send}. Terima kasih!`)}`;
    elements.whatsappButton.href = whatsappLink;
    elements.whatsappButton.style.display = 'inline-flex';
  } else {
    elements.whatsappButton.style.display = 'none';
  }

  elements.orderModal.classList.add('active');
};

const closeOrderModal = () => {
  elements.orderModal.classList.remove('active');
};

// Event Binding with debounce on search input for performance
elements.refreshButton.addEventListener('click', () => {
  state.completedItemsShown = state.itemsPerLoad;
  fetchDeliveryData();
});

elements.searchBox.addEventListener('input', debounce((e) => {
  state.searchTerm = e.target.value;
  state.completedItemsShown = state.itemsPerLoad;
  renderCards(state.searchTerm);
}, 300));

elements.statusFilterEl.addEventListener('change', (e) => {
  state.statusFilter = e.target.value;
  state.completedItemsShown = state.itemsPerLoad;
  renderCards(state.searchTerm);
});

elements.closeModalButton.addEventListener('click', closeOrderModal);

elements.orderModal.addEventListener('click', (e) => {
  if (e.target === elements.orderModal) {
    closeOrderModal();
  }
});

elements.loadMoreBtn.addEventListener('click', () => {
  state.completedItemsShown += state.itemsPerLoad;
  renderCards(state.searchTerm);
});

// Initialize app
updateLiveTime();
setInterval(updateLiveTime, 1000);
fetchDeliveryData();
